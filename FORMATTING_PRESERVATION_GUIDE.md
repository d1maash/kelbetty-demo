# Руководство по сохранению форматирования при импорте документов

## Проблема
При импорте DOCX документов в проект терялись:
- Отступы абзацев (margin-left, margin-right)
- Размеры шрифтов (font-size)
- Отступы первой строки (text-indent)
- Межстрочный интервал (line-height)
- Выравнивание текста (text-align)

## Решение

### 1. Улучшена функция конвертации (`src/lib/docx.ts`)

#### Основные изменения:
- **Улучшена обработка отступов**: Более точная обработка margin-left, margin-right, text-indent
- **Улучшена обработка размеров шрифтов**: Ограничение разумными пределами (6-72pt)
- **Добавлена функция `enhanceFormattingPreservation()`**: Дополнительная обработка HTML для улучшения сохранения форматирования
- **Исправлена обработка висячих отступов**: Правильная обработка hanging indent

#### Ключевые функции:
```typescript
// Улучшенная обработка отступов
function buildParagraphStyle(paragraph: any, resolvedStyle: ResolvedParagraphStyle): string

// Улучшенная обработка размеров шрифтов
function buildRunStyle(run: any, resolvedParagraphStyle: ResolvedParagraphStyle, context: FormattingContext): string

// Дополнительная обработка для улучшения сохранения форматирования
function enhanceFormattingPreservation(html: string): string
```

### 2. Улучшены CSS стили

#### Создан новый файл `src/styles/formatting-preservation.css`:
- **Приоритет inline стилей**: Inline стили имеют максимальный приоритет
- **Селекторы `:not([style])`**: Базовые стили применяются только к элементам БЕЗ inline стилей
- **Специальные стили для Word**: Поддержка MsoNormal, MsoHeading, MsoIndent и других классов

#### Обновлен `src/styles/fast-import.css`:
- Добавлены комментарии о приоритете inline стилей
- Улучшена обработка отступов и размеров шрифтов

### 3. Обновлен компонент отображения

#### `src/components/editor/ImportedDocumentViewer.tsx`:
- Убраны конфликтующие inline стили из компонента
- Добавлен класс `formatting-preservation`
- Импортирован новый CSS файл

### 4. Создана тестовая страница

#### `src/app/test-formatting/page.tsx`:
- Страница для тестирования сохранения форматирования
- Загрузка DOCX файлов
- Отображение результата с сохранением всех стилей

## Как использовать

### 1. Тестирование
Перейдите на `/test-formatting` для тестирования импорта с сохранением форматирования.

### 2. Импорт документов
Используйте существующий API `/api/import` - он теперь автоматически сохраняет форматирование.

### 3. Отображение документов
Компонент `ImportedDocumentViewer` теперь использует улучшенные стили для максимального сохранения форматирования.

## Что сохраняется

✅ **Отступы абзацев** (margin-left, margin-right)  
✅ **Размеры шрифтов** (font-size)  
✅ **Отступы первой строки** (text-indent)  
✅ **Висячие отступы** (hanging indent)  
✅ **Межстрочный интервал** (line-height)  
✅ **Выравнивание текста** (text-align)  
✅ **Цвета текста** (color)  
✅ **Семейства шрифтов** (font-family)  
✅ **Форматирование текста** (bold, italic, underline)  
✅ **Отступы до и после абзацев** (margin-top, margin-bottom)  

## Технические детали

### Приоритет стилей:
1. **Inline стили** (style="...") - максимальный приоритет
2. **CSS классы** (.formatting-preservation) - базовые стили
3. **Стили по умолчанию** - fallback стили

### Обработка отступов:
- `margin-left/right` - отступы слева/справа
- `text-indent` - отступ первой строки
- `padding-left` - для висячих отступов

### Обработка размеров шрифтов:
- Ограничение: 6pt - 72pt
- Формат: точные значения в pt
- Поддержка дробных значений

## Результат

Теперь импортированные документы отображаются максимально близко к оригиналу с сохранением всех форматирований:
- Отступы сохраняются точно
- Размеры шрифтов соответствуют оригиналу
- Межстрочный интервал сохраняется
- Выравнивание текста не теряется
