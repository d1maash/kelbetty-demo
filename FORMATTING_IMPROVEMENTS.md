# Улучшения форматирования документов

## Обзор
Этот документ описывает улучшения, добавленные в систему импорта DOCX для максимального сохранения форматирования исходных документов.

## Поддерживаемые свойства форматирования

### 1. Выравнивание текста (Text Alignment)
- ✅ **Левое** (`left`, `start`)
- ✅ **По центру** (`center`, `centered`, `middle`)
- ✅ **Правое** (`right`, `end`)
- ✅ **По ширине** (`justify`, `both`, `distributed`)

**Реализация:** Функция `mapAlignment()` в `src/lib/docx.ts`

### 2. Направление текста (Text Direction)
- ✅ **LTR** (слева направо)
- ✅ **RTL** (справа налево)

### 3. Отступы (Indents)
- ✅ **Отступ слева** (`margin-left`)
- ✅ **Отступ справа** (`margin-right`)
- ✅ **Отступ первой строки** (`text-indent`)
- ✅ **Висячий отступ** (negative `text-indent` + `padding-left`)

### 4. Межстрочный интервал (Line Spacing)
- ✅ **Одинарный** (1.0)
- ✅ **Полуторный** (1.15)
- ✅ **Двойной** (2.0)
- ✅ **Произвольный** (любое значение)

### 5. Размеры шрифтов (Font Sizes)
- ✅ Все размеры сохраняются в **pt** (points)
- ✅ Автоматическое ограничение: от 6pt до 72pt
- ✅ Поддержка дробных значений (например, 10.5pt)

### 6. Шрифты (Font Families)
- ✅ **Calibri**
- ✅ **Times New Roman**
- ✅ **Arial**
- ✅ **Helvetica**
- ✅ **Verdana**
- ✅ **Courier New**
- ✅ Любые другие шрифты (с предупреждением, если недоступны)

### 7. Стили текста (Text Styles)
- ✅ **Жирный** (`font-weight: bold`)
- ✅ **Курсив** (`font-style: italic`)
- ✅ **Подчеркивание** (`text-decoration: underline`)
- ✅ **Зачеркивание** (`text-decoration: line-through`)
- ✅ **Комбинация** (подчеркивание + зачеркивание)

### 8. Цвета (Colors)
- ✅ **Цвет текста** - все форматы:
  - HEX: `#FF0000`, `#F00`
  - RGB: `rgb(255, 0, 0)`
  - Именованные: `red`, `blue`, `green`, и т.д.
  - Word цвета: `darkblue`, `darkcyan`, и т.д.
  
- ✅ **Цвет фона (highlight)** - все те же форматы

**Реализация:** Функция `normalizeColor()` в `src/lib/docx.ts`

### 9. Верхний и нижний индексы
- ✅ **Верхний индекс** (superscript) - x²
- ✅ **Нижний индекс** (subscript) - H₂O

### 10. Специальные эффекты текста
- ✅ **Small Caps** (капитель)
- ✅ **All Caps** (все заглавные)

### 11. Интервалы абзацев (Paragraph Spacing)
- ✅ **Отступ перед абзацем** (`margin-top`)
- ✅ **Отступ после абзаца** (`margin-bottom`)

### 12. Полные поля документа (Section Margins)
- ✅ **Верхнее поле** (`padding-top`)
- ✅ **Нижнее поле** (`padding-bottom`)
- ✅ **Левое поле** (`padding-left`)
- ✅ **Правое поле** (`padding-right`)

## Техническая реализация

### Файлы
- **`src/lib/docx.ts`** - основная логика конвертации
- **`src/components/DocumentIframeViewer.tsx`** - изолированный рендеринг
- **`src/app/api/import/route.ts`** - API для импорта через LibreOffice
- **`src/app/api/import-simple/route.ts`** - API для импорта через mammoth

### Ключевые функции

#### `buildParagraphStyle()`
Обрабатывает стили параграфа:
- Отступы и поля
- Выравнивание
- Межстрочный интервал
- Направление текста

#### `buildRunStyle()`
Обрабатывает стили текстовых фрагментов:
- Размер и семейство шрифта
- Цвет текста и фона
- Жирность, курсив, подчеркивание
- Верхний/нижний индексы
- Специальные эффекты

#### `mapAlignment()`
Преобразует выравнивание Word в CSS:
```typescript
'center' → 'center'
'right' → 'right'
'both' → 'justify'
'left' → 'left'
```

#### `normalizeColor()`
Преобразует цвета Word в CSS:
```typescript
'FF0000' → '#FF0000'
'red' → '#FF0000'
'darkblue' → '#00008B'
```

## Режимы изоляции

### Iframe изоляция
Документ рендерится в `<iframe>` с `sandbox="allow-same-origin"`:
- ✅ Полная изоляция от CSS приложения
- ✅ Сброс всех стилей (`all: initial`)
- ✅ Встроенные шрифты через `@font-face`
- ✅ CSP: `script-src 'none'` для безопасности

### Inline стили
Все стили применяются как **inline CSS**:
- Максимальная точность
- Не переопределяются внешними CSS
- Сохраняются при экспорте

## Логирование и отладка

### Включенное логирование
```
[convertDocxToHtmlWithStyles] НАЧАЛО функции
[convertDocxInternal] Шаг 1-13: Детальный прогресс
[applyParagraphStyles] Обработка X маркеров
[buildParagraphStyle #1-5] paragraph.alignment
[mapAlignment] Неизвестное выравнивание (предупреждение)
```

### Отладочная информация
- Количество маркеров параграфов
- Количество маркеров текстовых фрагментов
- Размер HTML на каждом этапе
- Предупреждения о неизвестных форматах

## Оптимизация производительности

### До оптимизации
- **O(n²)** сложность в `applyParagraphStyles`
- Зависание на документах > 100 параграфов

### После оптимизации
- **O(n)** сложность
- Прогресс-индикация каждые 50 параграфов
- Таймаут 90 секунд для безопасности

## Примеры использования

### Импорт документа
```typescript
import { importDocx } from '@/lib/docx/import'

const result = await importDocx(file, {
  mode: 'libreoffice', // или 'jsDocxToHtml'
  fallbackOnError: true,
  minFidelityScore: 0.7
})
```

### Рендеринг в iframe
```tsx
<DocumentIframeViewer
  document={{
    id: doc.id,
    title: doc.title,
    html: doc.html,
    css: doc.css, // опционально
    type: 'docx',
    createdAt: doc.createdAt,
    updatedAt: doc.updatedAt
  }}
/>
```

## Известные ограничения

1. **Таблицы**: Базовая поддержка (границы, отступы)
2. **Изображения**: Поддерживаются через base64
3. **Списки**: Поддерживаются с базовым форматированием
4. **Колонки**: Не поддерживаются (конвертируются в одну колонку)
5. **Комментарии и изменения**: Не сохраняются

## Следующие шаги

### Планируемые улучшения
- [ ] Поддержка табуляции
- [ ] Улучшенная поддержка таблиц (объединение ячеек, стили)
- [ ] Поддержка границ абзацев
- [ ] Поддержка теней текста
- [ ] Поддержка градиентов фона

### Тестирование
- [x] Визуальное тестирование (скриншоты)
- [x] Сравнение вычисленных стилей
- [x] Проверка fallback механизма
- [ ] Автоматическое тестирование на большом наборе документов

## Вклад

При добавлении новых свойств форматирования:
1. Обновите `buildParagraphStyle()` или `buildRunStyle()`
2. Добавьте соответствующую функцию маппинга (если нужно)
3. Добавьте логирование для отладки
4. Обновите этот документ
5. Добавьте тесты

## Ссылки

- [DOCX Standard](http://officeopenxml.com/)
- [Mammoth.js Documentation](https://github.com/mwilliamson/mammoth.js)
- [LibreOffice Filters](https://wiki.documentfoundation.org/Documentation/DevGuide/Spreadsheet_Documents#HTML_and_Web_Page_Filters)

